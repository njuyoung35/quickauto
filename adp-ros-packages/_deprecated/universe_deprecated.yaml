universe:
  - module: system # 고수준 상태, 모니터링, emergency_handler 등 관리

  - module: simulator

  - module: vehicle # 차량 인터페이스. control 토픽 받아 실제/시뮬레이션 차량 구동

  - module: control
    children:
      - pkg: ssu_pid_longitudinal_controller
        lang: rust
        type: algorithm
        purpose: |
          computes the target acceleration to achieve the target velocity.
        design: |
          # real / sim debugging

          # state machine

          ## states
          - DRIVE
          - STOPPING
          - STOPPED
          - EMERGENCY

          # slope compensation (feedforward control)
          - **not implemented**

          # what is feedforward control?
          - feedback control : 현재 발생한 오차를 측정해서 보정하는 반응형 제어
          - feedforward control : 미리 예측해서 필요한 제어 입력을 주는 예방형 제어 (경사로 대응 위하여)
            - 언덕 오르막에서의 물리 법칙
            - 필요한 총 가속도 = 목표 가속도 + 중력 가속도 × sin(경사각)
            - 이상적인 조건에서는 FF만으로도 완벽한 속도 추종 가능 (모델 예측 제어적 접근)
            - 그러나, 모델링 오차, 외란, discretization 오차 등을 보정하기 위해 최후 수단으로 FB 제어기인 PID가 위치한다.

          # PID control (feedback control)
            
          ## why do we have maximum/miuimum limits for the output of each term?
            - to prevent large integral terms may cause unintended behavior by users
            - to prevent unintended noise (from derivative term) to be very large

        inputs:
          - msg: traj
            type: ssu_planning_msgs/Trajectory
          - msg: odom
            type: nav_msgs/Odometry
        outputs:
          - msg: long
            type: ssu_control_msgs/Longitudinal
        parameters:
          - name: delay_longitudinal_time
            type: double
            unit: s
            description: delay for longitudinal control
            default: 0.17
          - name: max_acc
            type: double
            unit: "m/s^2"
            description: max value of output acceleration
            default: 3.0
          - name: min_acc
            type: double
            unit: "m/s^2"
            description: min value of output acceleration
            default: -5.0
          - name: max_jerk
            type: double
            unit: "m/s^3"
            description: max value of jerk of output acceleration
            default: 2.0
          - name: min_jerk
            type: double
            unit: "m/s^3"
            description: min value of jerk of output acceleration
            default: -5.5
          
          - group: DRIVE
            children:
              - name: kp
                type: double
                unit: constant
                description: p gain for longitudinal control
                default: 0.5
              - name: ki
                type: double
                unit: constant
                description: i gain for longitudinal control
                default: 0.1
              - name: kd
                type: double
                unit: constant
                description: d gain for longitudinal control
                default: 0.0
              - name: max_acc_out
                type: double
                unit: "m/s^2"
                description: max value of PID's output acceleration during DRIVE state
                default: 1.0
              - name: min_acc_out
                type: double
                unit: "m/s^2"
                description: min value of PID's output acceleration during DRIVE state
                default: -1.0
              - name: max_p_effort
                type: double
                unit: constant
                description: max value of acceleration with p gain
                default: 1.0
              - name: min_p_effort
                type: double
                unit: constant
                description: min value of acceleration with p gain
                default: -1.0
              - name: max_i_effort
                type: double
                unit: constant
                description: max value of acceleration with i gain
                default: 0.3
              - name: min_i_effort
                type: double
                unit: constant
                description: min value of acceleration with i gain
                default: -0.3
              - name: max_d_effort
                type: double
                unit: constant
                description: max value of acceleration with d gain (in autoware universe, it is really zero.)
                default: 0.0
              - name: min_d_effort
                type: double
                unit: constant
                description: min value of acceleration with d gain (in autoware universe, it is really zero.)
                default: 0.0
              
        references:
          - "https://autowarefoundation.github.io/autoware_universe/main/control/autoware_pid_longitudinal_controller/#parameter-description"
          - "https://github.com/autowarefoundation/autoware_universe/tree/main/control/autoware_pid_longitudinal_controller"
          - "https://github.com/autowarefoundation/autoware_universe/blob/main/control/autoware_pid_longitudinal_controller/schema/autoware_pid_longitudinal_controller.schema.json"

      - pkg: ssu_pure_pursuit
        type: algorithm

      - pkg: ssu_mpc_lateral_controller
        type: algorithm

      - pkg: ssu_trajectory_follower
        lang: cpp
        type: node
        inputs:
            - msg: traj
              type: ssu_planning_msgs/Trajectory
            - msg: odom
              type: nav_msgs/Odometry
            - msg: steer
              type: ssu_vehicle_msgs/SteeringReport
        outputs:
            
  # - module: localization
  
  - module: map
    children:
      - pkg: ssu_global_map
        type: algorithm
        purpose: |
          원하는 경로 탐색 지역을 선택해서 그 안에 해당하는 ITS 국가교통정보센터에서 제공하는 표준노드링크 정보와 OpenStreetMap 지도 정보를
          Global Planner에 전달하고, 추가로 지도 정보를 시뮬레이터(RViz/Autoware)에 표시하기 위함이다.
        
        design: |
          1. ITS 교통정보센터에서 오픈데이터로 주는 표준노드링크 데이터(https://www.its.go.kr/nodelink/nodelinkRef)가 필요하다.
          (그 중 shp 파일들은 위치정보를 위경도 형식으로 바꾼 결과로 전달한다.
          * 중요: 이 시뮬레이션에서는 데이터가 따로 포함되어 있지 않으므로,
          * 본 시뮬레이션을 이용하려는 사용자는 다음과 같이 진행해야 한다.
          ** 진행 방법:
              - 1. 표준노드링크 데이터를 받을 수 있는 웹사이트(위의 1에서의 링크)로 이동해 가장 최신의 데이터 다운로드
              - 2. Python에서 geopandas를 이용해 MOCT_NODE.shp, MOCT_LINK.shp 파일들을 각각 읽어 gdf_node, gdf_road로 저장(geopandas.read_file() 이용)
              - 3. gdf_node(혹은 road)['geometry'].to_crs("EPSG:4326") 코드로 위치 정보를 위경도로 변환해
              노드 정보는 MOCT_NODE_revised.csv로, 도로 정보는 MOCT_LINK_revised.csv로 저장
              - 4. 3에서 저장한 두 csv 파일들을 adp-ros-packages/ssu_ws/data에다 가져다놓기
          )
          위 과정을 진행하고 난 후의 결과에 해당되는 파일들이 로드된다.
                2. 사용자가 선택한 도/시/구(region, 본 시뮬레이션에서는 서울시를 예시로 들었음)의
          위경도 범위를 나타내는 bounding box(이 정보는 따로 csv 파일로 저장되었음,
          선택한 region에 해당되는 정보가 추출됨), 또는 직접 지정한 bounding box를 시뮬레이터에서 입력으로 받는다.
          3. 2에서 입력받은 bounding box에서 설명하는 위경도 범위에 해당하는 node/link만 1의
          MOCT_NODE_revised.csv, MOCT_LINK_revised.csv에서 필터링하여 내부 그래프 구조로 저장한다.
          4. 2에서 선택한 region에 해당하는 OpenStreetMap 기반 HD Map (lanelet2 등)은
          Autoware의 map_loader를 통해 로드되고, ssu_global_map은 해당 map frame 상에서
          3에서의 표준노드링크 노드/링크를 Marker로 시각화한다.
          5. 3번에서 필터링된 node/link 그래프를 ssu_global_planner에 msg 형태로 제공한다.
        inputs:
          - msg: region_name
            type: string
            description: |
              전역 경로 탐색을 위한 기본 행정구역 이름 (예: "seoul").
          - msg: region_bbox
            type: double[4]
            description: |
              [min_lon, min_lat, max_lon, max_lat] 형식의 위경도 bounding box.
              region_name이 설정되어 있지 않거나 직접 bounding box를 지정하고 싶을 때 사용.
          - msg: moct_node_csv
            type: string
            description: MOCT_NODE_revised.csv 파일 경로.
          - msg: moct_link_csv
            type: string
            description: MOCT_LINK_revised.csv 파일 경로.
          - msg: map_frame_id
            type: string
            default: "map"
            description: Autoware에서 사용하는 지도 좌표계 frame_id.
          - srv: set_region
            type: ssu_map_msgs/srv/SetRegion
            description: |
              런타임에 region_name 또는 region_bbox를 바꾸고, 이에 맞는 node/link 그래프를 다시 로드하도록 하는 서비스.
              Request: region_name(string), min_lon, min_lat, max_lon, max_lat (옵션)
              Response: 성공 여부 및 실제 적용된 bounding box
        outputs:
          - msg: standard_graph
            topic: /ssu_ws/map/standard_graph
            type: ssu_map_msgs/msg/StandardGraph
            description: |
              선택된 region에 해당하는 표준노드링크 그래프 정보.
              (node 리스트, link 리스트, 각 link의 polyline 좌표 등 포함)
          - msg: node_markers
            topic: /ssu_ws/map/node_markers
            type: visualization_msgs/msg/MarkerArray
            description: RViz에서 표준노드링크 node를 시각화하기 위한 마커.
          - msg: link_markers
            topic: /ssu_ws/map/link_markers
            type: visualization_msgs/msg/MarkerArray
            description: RViz에서 표준노드링크 link(도로)를 시각화하기 위한 마커.
          - msg: map_info
            topic: /ssu_ws/map/info
            type: ssu_map_msgs/msg/MapInfo
            description: |
              사용 중인 region_name, bounding box, 사용된 csv 경로 등의 메타데이터.
        
        
  - module: perception

  - module: planning
    children:
      - pkg: ssu_local_planner
        lang: cpp
        type: node
        purpose: |
          차량이 주행할 국소경로를 생성하는 로컬플래너이다.
          전역 경로, 차량의 상태 정보, 장애물 인식을 종합하여 현재 상황에 가장 적합한 회피 경로 또는 기본 레이스라인을 선택해서 발행한다.

          주요기능 : 
            장애물 감지 및 유효 장애물 선택
            회피 필요 여부 판단
            스플라인 기반 회피 경로 생성
            회피 경로 이후 전역 경로로의 자연스러운 복귀
            최종 local waypoints 발행
        design: |
          로컬플래너는 3가지 입력이 필요함.
          - 글로벌 플래너가 계산한 global_waypoints
          - Perception 모듈에서 감지된 장애물 정보
          - 차량의 Frenet 좌표계 (s, d) 또는 시뮬에서 위치정보?  <<<<<<프레넷좌표계로 변환하는 부분 찾기 필요
          
          # 현재 spliner sub/pub (forzaETH spliner readme)

          ## Input/Output Topic Signature
          
            This node subscribes to:
            - `/perception/obstacles`: Subscribes to the obstacle array.
            - `/car_state/odom_frenet`: Reads the car's state
            - `/global_waypoints`: Subscribes to global waypoints.
            - `/global_waypoints_scaled`: Subscribes to the scaled global waypoints to obtain the current target velocities.
                
            The node publishes to:
            - `/planner/avoidance/markers`: Publishes spline markers.
            - `/planner/avoidance/otwpnts`: Publishes splined waypoints.
            - `/planner/avoidance/considered_OBS`: Publishes markers for the closest obstacle.
            - `/planner/avoidance/propagated_obs`: Publishes markers for the propagated obstacle.
            - `/planner/avoidance/latency`: Publishes the latency of the spliner node. (only if measuring is enabled)

          **1. 장애물 선택**
           - /perception/obstacles 토픽을 받아 장애물 1개 선택
           - lateral 거리(d)가 obs_traj_tresh 이하일 때 회피필요 판단!(Detect/Tracking)
            (~/forza_ws/race_stack/stack_master/planner/local_planners/spline_planner/spline_planner.py)
           
          **2. 회피 필요 여부 판단**
            (~/forza_ws/race_stack/stack_master/planner/local_planners/spline_planner/spline_planner.py)
           - 차량 기준 left/right 중 더 넓은 공간(d_left, d_right)을 판단하여 회피
            (d_left = 트랙 중앙선(레이스라인)에서 트랙 왼쪽 경계까지의 거리)
           - spline_bound_mindist 조건을 통해 스플라인이 트랙 밖으로 벗어나지 않는지 확인
           - apex 주변에 pre/post apex 제어점을 생성하여 회피 경로 구조를 만든다.
                ##spline does not get too close to the track boundaries.
                - `pre_apex_0`: Sets the first distance in front of the apex in meters, used in the calculation of the spline.
                - `pre_apex_1`: Sets the second distance in front of the apex in meters, used in the calculation of the spline.
                - `pre_apex_2`: Sets the third distance in front of the apex in meters, used in the calculation of the spline.
                - `post_apex_0`: Sets the first distance behind the apex in meters, used in the calculation of the spline.
                - `post_apex_1`: Sets the second distance behind the apex in meters, used in the calculation of the spline.
                - `post_apex_2`: Sets the third distance behind the apex in meters, used in the calculation of the spline.
                - `kd_obs_pred`: Sets the gain for the obstacle prediction, used in the calculation of the obstacle prediction.
                - `fixed_pred_time`: Sets the fixed prediction time, used in the calculation of the obstacle prediction.
            ==> apex : 장애물 회피를 위해 차량이 가장 크게 꺾어서 지나가야 하는 핵심 지점(피크 지점)
            ==> 기본 raceline → (회피를 시작) → apex를 중심으로 휘어지기 → 다시 raceline 합류
            ==> apex는 장애물 회피궤적의 중심
            ==> 장애물에서 얼마나 떨어져 지나갈지(evasion_dist), 트랙 경계와의 최소 거리 확보(spline_bound_mindist) 이 두 개를 만족하도록 apex계산됨
            ==> apex찍기: 자차 frenet s값(현재위치), 장애물의 s값, 장애물이 raceline에서 얼마나 벗어났는지 d값, 차량속도(빠르면 pre/post apex 더 멀리 배치)
        
          **3. 스플라인 경로 생성**
           - apex 기준으로 pre_apex_* / post_apex_* 제어점 배치
           - 속도에 따라 pre/post apex 간격 증가
           - evasion_dist(기본 lateral evasion 거리(옆으로 얼마나 비켜갈지)) 만큼 횡방향 offset 적용
        
          **4. 회피 후 복귀**
           - post_apex_* 이후 전역 경로로 완만하게 복귀
           - splini_ttl을 이용하여 회피 경로의 유효시간 관리 (해당 카운터를 모두 채우면, global waypoints로 복귀)
           (~/forza_ws/race_stack/stack_master/config/state_machine_params.yaml)

          **5. 토픽 발행**
           - 최종 로컬 경로 발행
           - 회피 마커 및 장애물 마커를 시각화

        inputs:
          - msg: /perception/obstacles
            type: custom_msgs/obstacleArray
            description: |
              감지 및 필터링된 장애물 집합
              - Detect.cpp & Tracking.py
              - ~/forza_ws/race_stack/stack_master/config/opponent_tracking_param_cpp.yaml
              - .../opponent_tracker_params.yaml 

          - msg: /car_state/odom_frenet
            type: /ssu_msgs/msg/FrenetState
            description: 차량 Frenet 좌표
          
          - msg: /global_waypoints
            type: nav_msgs/msg/Path
            description: |
              최소곡률 raceline
              - ~/forza_ws/race_stack/planner/global_planner/global_planner/readwrite_global_waypoints.py forza에서 주행 시 읽을 웨이포인트 파일 변경(path 수정)

          - msg: /global_waypoints_scaled
            type: nav_msgs/msg/Path
            description: |
              속도값이 부여된 전역 경로
              - 현재 주행라인(레이스라인)을 생성하면 global_waypoints.json, speed_scaling.yaml, ot_sectors.yaml 파일 생성됨.
   
        outputs:
          - msg: /planning/local_waypoints
            type: nav_msgs/msg/Pathmsgs
            description: 최종 로컬 경로
          
          - msg: /planner/avoidance/markers
            type: visualization_msgs/msg/MarkerArray
            description: 회피 스플라인 시각화

          - msg: /planner/avoidance/otwpnts
            type: nav_msgs/msg/Path
            description: spline 기반 회피 경로

          - msg: /planner/avoidance/considered_OBS
            type: visualization_msgs/msg/MarkerArray
            description: 장애물 마커

          - msg: /planner/avoidance/propageted_obs
            type: visualization_msgs/msg/MarkerArray
            description: 장애물 예측 마커

        parameters:
        # **아마도 손대야할 파라미터, 도로주행 가능한 차량 기준으로**
        # 단위가 미터(m)라는 근거는 ForzaETH 공식 문서(spliner -> README)와 코드 내부 좌표계(Frenet s/d 단위)가 모두 ‘미터’를 사용하기 때문임.
          - name: evasion_dist
            type: double
            unit: m
            description: apex에서 장애물을 비켜가기 위한 lateral offset (차량 폭의 절반보다 크게 설정 권장)

          - name: obs_traj_tresh
            type: double
            unit: m
            description: 장애물이 raceline에 얼마나 가까우면 회피 대상으로 판단할지

          - name: spline_bound_mindist
            type: double
            unit: m
            description: 스플라인이 트랙 경계에 얼마나 가까워질 수 있는지 최소 마진 (차선변경 기준으로 바꿔야할듯)

            # pre_apex_2   pre_apex_1   pre_apex_0   APEX   post_apex_0   post_apex_1   post_apex_2
            #     -4m         -3m          -1.5m     0m        +2m         +3m          +4m
            # apex 이전 : 음수, apex 이후 : 양수
          - name: pre_apex_0
            type: double
            unit: m
            description: 

          - name: pre_apex_1
            type: double
            unit: m
            description: 

          - name: pre_apex_2
            type: double
            unit: m
            description: 

          - name: post_apex_0
            type: double
            unit: m
            description: 

          - name: post_apex_1
            type: double
            unit: m
            description: 

          - name: post_apex_2
            type: double
            unit: m
            description: 

          - name: kd_obs_pred
            type: double
            unit: ??
            description: 장애물 예측 위치를 해당 scale만큼 보정(1.0이면 그대로 사용함을 의미)

          - name: fixed_pred_time
            type: double
            unit: s
            description: 앞으로 해당 시간동안의 장애물 예측 궤적을 계산(장애물이 constant 모드로 달릴 때만 적용)

      - pkg: ssu_global_planner
        lang: cpp
        type: algorithm
        purpose: |
          ssu_global_map 패키지에서 준 지도 정보를 바탕으로
          시작지점과 목적지점에 해당되는 위경도 정보를 주었을 때
          이들을 연결하는 최단 경로를 다익스트라 알고리즘을 이용해서
          전역 경로를 만들고, 그 정보를 waypoints 형식으로
          차량 지역 경로 생성기로 전달해 경로 생성에 도움을 준다.
        design: |
          1. ssu_global_map이 퍼블리시하는 표준노드링크 그래프(ssu_map_msgs/StandardGraph)를 구독하여
            내부 adjacency list(노드 그래프)로 저장한다.
          2. 사용자(또는 상위 모듈)로부터 GlobalNavigateFromTo 서비스 요청
            (start_lat, start_lon, goal_lat, goal_lon)을 받는다.
          3. start/goal 위경도를 그래프 상에서 가장 가까운 노드로 snap한 후,
            다익스트라 알고리즘으로 최단경로를 계산한다.
          4. 최단경로에 해당하는 노드/링크를 따라 polyline을 재구성하여
            nav_msgs/Path 형식의 global_waypoints를 생성하고,
            필요시 목표 속도(profiling)를 부여하여 global_waypoints_scaled를 생성한다.
          5. 전역 경로는 RViz에서 확인할 수 있도록 MarkerArray 형태로도 발행한다.
          6. 서비스 응답에는 nav_msgs/Path 및 노드/도로 이름 리스트를 포함시켜
            UI에서 텍스트 형태의 경로 설명도 제공할 수 있게 한다.

        inputs:
          - msg: standard_graph
            topic: /ssu/map/standard_graph
            type: ssu_map_msgs/msg/StandardGraph
            description: ssu_global_map에서 제공하는 표준노드링크 그래프 정보.
          - srv: navigate
            name: /ssu/global_planner/global_navigate_from_to
            type: ssu_map_msgs/srv/GlobalNavigateFromTo
            description: |
              시작/목적지 위경도를 입력으로 받아 전역 경로를 요청하는 서비스.
              Request: start_lat, start_lon, goal_lat, goal_lon, (옵션) start_yaw, goal_yaw
              Response: global_path(nav_msgs/Path), node_ids[], link_ids[], node_names[], road_names[]
          - msg: current_pose
            topic: /localization/kinematic_state # 예시, Autoware 기본 토픽과 맞춰도 됨
            type: geometry_msgs/msg/PoseStamped
            description: |
              차량의 현재 위치. 서비스를 사용하지 않고,
              "현재 위치 → 목적지" 형태로 바로 전역경로를 생성하는 모드에서 사용 가능.

        outputs:
          - msg: global_waypoints
            topic: /planning/global_waypoints
            type: nav_msgs/msg/Path
            description: |
              전역 경로를 구성하는 waypoint 리스트.
              ssu_local_planner의 /global_waypoints 입력으로 사용된다.
          - msg: global_waypoints_scaled
            topic: /planning/global_waypoints_scaled
            type: nav_msgs/msg/Path
            description: |
              속도 프로파일이 부여된 전역 경로.
              각 pose 또는 별도의 velocity 필드를 통해 목표 속도 정보를 포함한다.
          - msg: global_route_markers
            topic: /planning/global_route_markers
            type: visualization_msgs/msg/MarkerArray
            description: RViz에서 전역 경로를 강조해서 보여주기 위한 선/노드 마커.
          - srv: navigate (response)
            name: /ssu/global_planner/global_navigate_from_to
            type: ssu_map_msgs/srv/GlobalNavigateFromTo
            description: |
              서비스 응답으로 nav_msgs/Path 및 노드/도로 이름 정보를 포함해 반환.
              (UI/테스트 노드에서 응답을 이용해 텍스트 안내를 표시 가능)

        parameters:
          - name: node_snap_radius_m
            type: double
            unit: m
            default: 50.0
            description: |
              start/goal 위경도를 그래프 상 노드로 snap할 때 허용하는 최대 거리.
          - name: use_bidirectional_edges
            type: bool
            default: true
            description: |
              표준노드링크 그래프를 양방향 도로로 취급할지 여부.
          - name: default_target_velocity
            type: double
            unit: "m/s"
            default: 12.0
            description: |
              global_waypoints_scaled에 부여할 기본 목표 속도.
          - name: visualize_on_plan
            type: bool
            default: true
            description: 전역 경로 생성 시마다 MarkerArray를 함께 발행할지 여부.

  - module: sensing

  - module: sensor_kit
    children:
      - repo: https://github.com/autowarefoundation/sample_sensor_kit_launch.git
        dist: src/sensor_kit
        version: humble

  - module: ros2
    children:
      - repo: https://github.com/ros2/common_interfaces.git
        dist: src/ros2/common_interfaces
        version: humble
      - repo: https://github.com/ros2/rcl_interfaces.git
        dist: src/ros2/rcl_interfaces
        version: humble
      - repo: https://github.com/ros2/test_interface_files.git
        dist: src/ros2/test_interface_files
        version: humble
      - repo: https://github.com/ros2/rosidl_defaults.git
        dist: src/ros2/rosidl_defaults
        version: humble
      - repo: https://github.com/ros2/unique_identifier_msgs.git
        dist: src/ros2/unique_identifier_msgs
        version: humble

  - module: ros2-rust
    children:
      - repo: https://github.com/ros2-rust/ros2_rust.git
        dist: src/ros2-rust/ros2_rust
        version: main
        subpaths:
          - rclrs
      - repo: https://github.com/ros2-rust/rosidl_rust.git
        dist: src/ros2-rust/rosidl_rust
        version: main
      - repo: https://github.com/ros2-rust/rosidl_runtime_rs.git
        dist: src/ros2-rust/rosidl_runtime_rs
        version: main

  - repo: https://github.com/autowarefoundation/autoware_msgs.git
    dist: autoware_msgs
    version: main
