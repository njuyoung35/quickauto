               ┌──────────────────────────┐
               │ Lanelet2 Loader(우리 노드)│
               │  - lanelet2 map (.osm)   │
               │  - 벡터 정보 파싱         │
               └───────────┬──────────────┘
                           │
                           ▼
                   [전역 경로 생성기]
               (우리가 만든 global planner)
                           │
                           ▼
           /global_waypoints  (nav_msgs/Path)
                           │
                           ▼
                 [Local Planner - spliner]
               /planner/avoidance/otwpnts
                           │
                           ▼
                  [Adapter Node (L1 control)]
           AckermannControlCommand 발행
                           │
                           ▼
               [Autoware SPS - 차량 모델]
                     /output/odometry
                           │
                           ▼
                [state_estimation / carstate]
               /car_state/frenet/odom
                           │
                           ▼
                       Local Planner
                           │
                           └─── feedback loop


동시에 RViz2에서는:

lanelet 지도 시각화

global path 시각화

local path 시각화

SPS 차량(base_link) 위치

Frenet 상태

odom trajectory

Autoware 공식 근거

Autoware Universe 문서에서 SPS(Simple Planning Simulator)는
“vehicle dynamics only” 라고 명시됨.
➡ 지도, 센서, lanelet2 기능 없음.

==> ROS2 노드를 하나 만들어서 lanelet2 지도를 직접 로딩
my_lanelet_loader/
   lanelet_loader_node.py
   map.osm

---
import lanelet2
import rclpy
from rclpy.node import Node
from visualization_msgs.msg import MarkerArray

map_path = "/path/to/map.osm"

class LaneletViz(Node):
    def __init__(self):
        super().__init__('lanelet_viz')
        self.map = lanelet2.io.load(
            map_path, lanelet2.projection.UtmProjector(lanelet2.io.Origin())
        )
        self.marker_pub = self.create_publisher(MarkerArray, "/lanelet_map_markers", 10)
        self.publish_markers()

    def publish_markers(self):
        # 모든 lanelet을 Marker로 그려서 RViz2에서 보이도록 함
        ...

---
RViz2에서 /lanelet_map_markers 를 MarkerArray로 그린다.


## 우리 플래너에 lanelet 지도 벡터정보를 전달하는 방법

이건 ForzaETH Global Planner가 결정.
==> lanelet에서 centerline만 추출하여 전역 웨이포인트 생성

for ll in map.laneletLayer:
    centerline = ll.centerline
    for p in centerline:
        global_path.append((p.x, p.y))


## RViz2에서 “지도 + 차량 + 경로”를 보고 싶을 때
RViz2에 다음을 띄우면 됨:

/lanelet_map_markers → MarkerArray
/global_waypoints → Path
/planner/avoidance/otwpnts → Path 또는 custom marker
/output/odometry → TF + Pose
/car_state/frenet/odom → Frenet-based pose (optional)
/tf → base_link


---
정리

경로(path)는 lanelet2 → Global → Local → SPS
        - Global Planner 출력

            /global_waypoints (nav_msgs/Path 또는 WpntArray)

        - Local Planner 입력

            /global_waypoints

            /car_state/frenet/odom (차량 상태)

            Local Planner가 최종 local trajectory를 만듦:

            /planner/avoidance/otwpnts (OTWpntArray or Path)

        - AdapterNode가 이걸 AckermannControlCommand로 바꿈

            그리고 SPS에 보냄:

            /input/ackermann_control_command

상태(state)는 SPS → state_estimation(carstate_node) → LOCAL PLANNER
        플래너(Local planner)는 차량 상태(s,d, yaw, vs, vd)를 사용해서 경로를 따라가기 위한 스플라인 회피 경로 만듬
        그리고 그 상태 정보는 SPS가 차량을 움직인 결과이기 때문에 SPS가 먼저 던지고, local planner가 받아야
---

'''
1) 글로벌 플래너

/mnt/data/global_planner_logic_py, /readwrite_global_waypoints_py 등

/global_waypoints publish


2) 로컬 플래너 (spline_planner.py)
self.create_subscription(
    Odometry, '/car_state/frenet/odom', self.state_cb, QoSProfile(depth=10))

로컬 플래너는 carstate_node가 변환한 Frenet odom을 받게 되어 있음


3) SPS 출력

Autoware SPS에서 나오는 차량 상태:

/output/odometry (Odometry)

/tf (base_link pose)


4) carstate_node
self.odom_in_topic = self.get_parameter('/carstate_node/odom_topic').value

self.ekf_odom_sub = self.create_subscription(
    Odometry, self.odom_in_topic, self.ekf_odom_cb, 10)

즉, carstate_node 입력을 /output/odometry 로 바꾼다.


5) carstate_node 출력

Frenet 변환 후:

/car_state/frenet/odom

➡ spline_planner.py 가 여기서 상태를 읽음.


6) spline_planner → Adapter → SPS
---
/global_waypoints  
    │
    ▼
spline_planner  
    │
    ▼
/planner/avoidance/otwpnts  
    │
    ▼
AdapterNode(L1)  
    │
    ▼
/input/ackermann_control_command → SPS
---
'''

최종
---
           (PATH FLOW)
GLOBAL ─────────→ LOCAL ─────────→     SPS
                     ↑                      │
                     │                      │
                     └───── STATE FLOW ────┘
                          (SPS → carstate → LOCAL)
---
